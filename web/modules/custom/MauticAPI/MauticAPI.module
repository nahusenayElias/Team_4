<?php

function MauticAPI_field_storage_config_info() {
  return [
    'field_name' => 'mautic_segment',
    'type' => 'list_text',
    'settings' => [
      'allowed_values' => MauticAPI_fetch_mautic_segments(), 
    ],
  ];
}

/**
 * Implements hook_install().
 */
function MauticAPI_install() {
  $field_storage = \Drupal\field\Entity\FieldStorageConfig::create([
    'field_name' => 'field_mautic_user_segment',
    'entity_type' => 'node',
    'type' => 'list_string',
    'settings' => [
      'allowed_values' => MauticAPI_fetch_mautic_segments(), 
    ],
  ]);
  $field_storage->save();

  // Attach the field to a content type (e.g., article).
  $field = \Drupal\field\Entity\FieldConfig::create([
    'field_name' => 'field_mautic_user_segment',
    'entity_type' => 'node',
    'bundle' => 'article',  // Change 'article' to the content type you want.
    'label' => 'Mautic Segment',
  ]);
  $field->save();
}

function MauticAPI_fetch_mautic_segments() {
  $segments = MauticAPI_get_mautic_segments();
  if ($segments) {
    return [
      '#theme' => 'item_list', 
      'items' => $segments,
    ];
  }
  else {
    return 'No segments found.';
  }
}

function MauticAPI_get_mautic_segments() {
  
        $username = $_ENV['API_USER'];
        $api_key = $_ENV['API_KEY'];  
        $mautic_url = 'http://appserver.mauticapp.internal';
        $auth = base64_encode($username . ':' . $api_key);
        $client = \Drupal::httpClient();
    
        try {
          $response = $client->request('GET', $mautic_url . '/api/segments', [
            'headers' => [
              'Authorization' => 'Basic ' . $auth,
            ],
            'verify' => FALSE,
          ]);

          if ($response->getStatusCode() !== 200) {
            \Drupal::logger('mymodule')->error('Failed to fetch segments from Mautic. Status code: @status', ['@status' => $response->getStatusCode()]);
            return [];
          }
    
          $data = json_decode($response->getBody()->getContents(), TRUE);
    
          if (isset($data['lists'])) {
            $segments = $data['lists'];
            \Drupal::state()->set('MauticAPI.mautic_segments', $segments);
            foreach($segments as $segment) {
              $segment[] = $segment['name'];
            }
            return $segments;
          }
          else {
            \Drupal::logger('MauticAPI')->error('Mautic segments not found in the API response.');
            return [];
          }
        }
  catch (\Exception $e) {
    \Drupal::logger('MauticAPI')->error('Failed to fetch Mautic segments: ' . $e->getMessage());
    return [];
  }
}

/**
 * Implements hook_form_FORM_ID_alter() to dynamically populate segment options.
 */
function MauticAPI_form_node_article_alter(array &$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  // Check if the field exists (e.g., on the article content type).
  if (isset($form['field_mautic_segment'])) {
    // Fetch segments dynamically from Mautic API or state.
    $segments = MauticAPI_fetch_mautic_segments();

    // Populate the select list with Mautic segments.
    $form['field_mautic_segment']['widget'][0]['#options'] = $segments;
  }
}


function MauticAPI_form_node_article_form_alter(array &$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
 
  $segments = MauticAPI_get_mautic_segments();

  if ($segments) {
    $form['field_mautic_segments'] = [
      '#type' => 'select',
      '#title' => 'Select Mautic Segments',
      '#options' => array_combine($segments, $segments),
      '#multiple' => TRUE,
      '#default_value' => [],
    ];
  }
}

function MauticAPI_is_user_in_segment($email, $segments) {
  $client = \Drupal::httpClient();
  $api_url = 'http://appserver.mauticapp.internal/api/contacts/exists';
  $username = 'admin';
  $pw = '+Nimda666+';
  $auth = base64_encode($username.':'.$pw);

  $response = $client->get($api_url, [
    'query' => ['email' => $email],
    'headers' => ['Authorization' => 'Basic ' . $auth,
    ]
  ]);
  
  $data = json_decode($response->getBody()->getContents(), TRUE);
  $user_segments = $data['contact']['segments'];

  foreach ($segments as $segment) {
    if (in_array($segment, $user_segments)) {
      return TRUE;
    }
  }

  return FALSE;
}

